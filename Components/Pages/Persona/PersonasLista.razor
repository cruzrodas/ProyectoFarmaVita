@page "/personas"
@using ProyectoFarmaVita.Models
@using ProyectoFarmaVita.Services.PersonaServices
@using Microsoft.AspNetCore.Components.Web
@inject IPersonaService PersonaService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@implements IDisposable

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4">
	<MudPaper Elevation="3" Class="pa-4">
		<MudGrid>
			<!-- Header Section -->
			<MudItem xs="12" Class="d-flex justify-space-between align-center mb-4">
				<MudText Typo="Typo.h4" Class="d-flex align-center">
					<MudIcon Icon="@Icons.Material.Filled.People" Class="mr-3" Size="Size.Large" />
					Gestión de Personas
				</MudText>
				<MudButtonGroup Variant="Variant.Filled">
					<MudButton Color="Color.Primary"
							   StartIcon="@Icons.Material.Filled.PersonAdd"
							   OnClick="@(() => NavigationManager.NavigateTo("/personas/crear"))"
							   Class="new-person-button">
						Nueva Persona
					</MudButton>
				</MudButtonGroup>
			</MudItem>

			<!-- Filters Section -->
			<MudItem xs="12">
				<MudExpansionPanels Elevation="2" Class="mb-4">
					<MudExpansionPanel Icon="@Icons.Material.Filled.FilterList" Text="Filtros de Búsqueda">
						<MudGrid>
							<MudItem xs="12" sm="6" md="4" lg="3">
								<MudTextField @bind-Value="searchString"
											  Label="Buscar"
											  Placeholder="Nombre, Apellido, Email, DPI..."
											  Adornment="Adornment.Start"
											  AdornmentIcon="@Icons.Material.Filled.Search"
											  IconSize="Size.Medium"
											  Clearable="true"
											  DebounceInterval="500"
											  OnDebounceIntervalElapsed="@OnSearchChanged"
											  OnKeyUp="@OnSearchKeyUp" />
							</MudItem>
							<MudItem xs="12" sm="6" md="2">
								<MudSelect @bind-Value="filtroRol"
										   Label="Rol"
										   T="int?"
										   Clearable="true"
										   AdornmentIcon="@Icons.Material.Filled.Work"
										   Adornment="Adornment.Start">
									@if (roles?.Any() == true)
									{
										@foreach (var rol in roles)
										{
											<MudSelectItem T="int?" Value="@((int?)rol.IdRol)">@rol.TipoRol</MudSelectItem>
										}
									}
								</MudSelect>
							</MudItem>
							<MudItem xs="12" sm="6" md="2">
								<MudSelect @bind-Value="filtroSucursal"
										   Label="Sucursal"
										   T="int?"
										   Clearable="true"
										   AdornmentIcon="@Icons.Material.Filled.Business"
										   Adornment="Adornment.Start">
									@if (sucursales?.Any() == true)
									{
										@foreach (var sucursal in sucursales)
										{
											<MudSelectItem T="int?" Value="@((int?)sucursal.IdSucursal)">@sucursal.NombreSucursal</MudSelectItem>
										}
									}
								</MudSelect>
							</MudItem>
							<MudItem xs="12" sm="6" md="2">
								<MudSelect @bind-Value="filtroGenero"
										   Label="Género"
										   T="int?"
										   Clearable="true"
										   AdornmentIcon="@Icons.Material.Filled.Person"
										   Adornment="Adornment.Start">
									@if (generos?.Any() == true)
									{
										@foreach (var genero in generos)
										{
											<MudSelectItem T="int?" Value="@((int?)genero.IdGenero)">@genero.Ngenero</MudSelectItem>
										}
									}
								</MudSelect>
							</MudItem>
							<MudItem xs="12" sm="6" md="2">
								<MudSelect @bind-Value="filtroEstadoCivil"
										   Label="Estado Civil"
										   T="int?"
										   Clearable="true"
										   AdornmentIcon="@Icons.Material.Filled.Favorite"
										   Adornment="Adornment.Start">
									@if (estadosCiviles?.Any() == true)
									{
										@foreach (var estado in estadosCiviles)
										{
											<MudSelectItem T="int?" Value="@((int?)estado.IdEstadoCivil)">@estado.EstadoCivil1</MudSelectItem>
										}
									}
								</MudSelect>
							</MudItem>
							<MudItem xs="12" md="12" lg="12" Class="d-flex justify-end gap-2 mt-2">
								<MudButton Variant="Variant.Filled"
										   Color="Color.Primary"
										   StartIcon="@Icons.Material.Filled.Search"
										   OnClick="@OnBuscarClick"
										   Class="search-button">
									Buscar
								</MudButton>
								<MudButton Variant="Variant.Outlined"
										   Color="Color.Secondary"
										   StartIcon="@Icons.Material.Filled.Clear"
										   OnClick="@LimpiarFiltros">
									Limpiar Filtros
								</MudButton>
							</MudItem>
						</MudGrid>
					</MudExpansionPanel>
				</MudExpansionPanels>
			</MudItem>

			<!-- Table Section -->
			<MudItem xs="12">
				<MudTable T="Persona"
						  Dense="false"
						  Hover="true"
						  Loading="@loading"
						  LoadingProgressColor="Color.Primary"
						  ServerData="@LoadServerData"
						  @ref="table"
						  Elevation="2"
						  Class="custom-table">
					<LoadingContent>
						<div class="d-flex flex-column justify-center align-center loading-container">
							<MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" />
							<MudImage Src="images/Logo FarmaVita.png" Width="120" Height="120" Alt="FarmaVita Logo" Class="mt-4 pulse-img" />
							<MudText Class="mt-3" Typo="Typo.h6" Color="Color.Primary">Cargando personas...</MudText>
						</div>
					</LoadingContent>
					<HeaderContent>
						<MudTh>
							<MudTableSortLabel SortBy="new Func<Persona, object>(x => x.IdPersona)">
								<MudText Typo="Typo.subtitle1" Class="font-weight-bold">ID</MudText>
							</MudTableSortLabel>
						</MudTh>
						<MudTh>
							<MudTableSortLabel SortBy="new Func<Persona, object>(x => x.Nombre ?? string.Empty)">
								<MudText Typo="Typo.subtitle1" Class="font-weight-bold">Nombre Completo</MudText>
							</MudTableSortLabel>
						</MudTh>
						<MudTh Class="d-none d-md-table-cell">
							<MudTableSortLabel SortBy="new Func<Persona, object>(x => x.Email ?? string.Empty)">
								<MudText Typo="Typo.subtitle1" Class="font-weight-bold">Email</MudText>
							</MudTableSortLabel>
						</MudTh>
						<MudTh Class="d-none d-lg-table-cell">
							<MudText Typo="Typo.subtitle1" Class="font-weight-bold">DPI</MudText>
						</MudTh>
						<MudTh Class="d-none d-lg-table-cell">
							<MudText Typo="Typo.subtitle1" Class="font-weight-bold">Rol</MudText>
						</MudTh>
						<MudTh Class="d-none d-xl-table-cell">
							<MudText Typo="Typo.subtitle1" Class="font-weight-bold">Sucursal</MudText>
						</MudTh>
						<MudTh Class="d-none d-xl-table-cell">
							<MudText Typo="Typo.subtitle1" Class="font-weight-bold">Teléfono</MudText>
						</MudTh>
						<MudTh>
							<MudText Typo="Typo.subtitle1" Class="font-weight-bold">Estado</MudText>
						</MudTh>
						<MudTh Class="d-none d-md-table-cell">
							<MudTableSortLabel SortBy="new Func<Persona, object>(x => x.FechaCreacion ?? DateTime.MinValue)">
								<MudText Typo="Typo.subtitle1" Class="font-weight-bold">Fecha Registro</MudText>
							</MudTableSortLabel>
						</MudTh>
						<MudTh>
							<MudText Typo="Typo.subtitle1" Class="font-weight-bold">Acciones</MudText>
						</MudTh>
					</HeaderContent>
					<RowTemplate Context="row">
						<MudTd DataLabel="ID">
							<MudChip T="string" Color="Color.Info" Size="Size.Small" Label="true" Class="id-chip">
								#@row.IdPersona
							</MudChip>
						</MudTd>
						<MudTd DataLabel="Nombre Completo">
							<div class="d-flex flex-column">
								<MudText Typo="Typo.body1" Class="font-weight-medium">
									@($"{row.Nombre ?? ""} {row.Apellido ?? ""}")
								</MudText>
								<MudText Typo="Typo.caption" Color="Color.Secondary" Class="d-md-none">
									@(row.Email ?? "")
								</MudText>
							</div>
						</MudTd>
						<MudTd DataLabel="Email" Class="d-none d-md-table-cell">
							<MudText Typo="Typo.body2" Class="text-truncate email-cell" Title="@(row.Email ?? "")">
								@(row.Email ?? "Sin email")
							</MudText>
						</MudTd>
						<MudTd DataLabel="DPI" Class="d-none d-lg-table-cell">
							@if (row.Dpi.HasValue)
							{
								<MudText Typo="Typo.body2">@row.Dpi.Value.ToString("N0")</MudText>
							}
							else
							{
								<MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
									Sin DPI
								</MudChip>
							}
						</MudTd>
						<MudTd DataLabel="Rol" Class="d-none d-lg-table-cell">
							@{
								var rolText = GetRolText(row);
							}
							@if (!string.IsNullOrEmpty(rolText))
							{
								<MudChip T="string" Color="Color.Primary" Size="Size.Small" Label="true">
									@rolText
								</MudChip>
							}
							else
							{
								<MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
									Sin rol
								</MudChip>
							}
						</MudTd>
						<MudTd DataLabel="Sucursal" Class="d-none d-xl-table-cell">
							@{
								var sucursalText = GetSucursalText(row);
							}
							@if (!string.IsNullOrEmpty(sucursalText))
							{
								<MudText Typo="Typo.body2">@sucursalText</MudText>
							}
							else
							{
								<MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
									Sin sucursal
								</MudChip>
							}
						</MudTd>
						<MudTd DataLabel="Teléfono" Class="d-none d-xl-table-cell">
							@{
								var telefonoText = GetTelefonoText(row);
							}
							@if (!string.IsNullOrEmpty(telefonoText))
							{
								<MudText Typo="Typo.body2">@telefonoText</MudText>
							}
							else
							{
								<MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
									Sin teléfono
								</MudChip>
							}
						</MudTd>
						<MudTd DataLabel="Estado">
							<MudChip T="string"
									 Color="@(row.Activo == true ? Color.Success : Color.Error)"
									 Size="Size.Small"
									 Label="true"
									 Icon="@(row.Activo == true ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)">
								@(row.Activo == true ? "Activo" : "Inactivo")
							</MudChip>
						</MudTd>
						<MudTd DataLabel="Fecha Registro" Class="d-none d-md-table-cell">
							@if (row.FechaCreacion.HasValue)
							{
								<div class="d-flex flex-column">
									<MudText Typo="Typo.body2">@row.FechaCreacion.Value.ToString("dd/MM/yyyy")</MudText>
									<MudText Typo="Typo.caption" Color="Color.Secondary">
										@row.FechaCreacion.Value.ToString("HH:mm")
									</MudText>
								</div>
							}
							else
							{
								<MudChip T="string" Size="Size.Small" Color="Color.Default" Variant="Variant.Outlined">
									Sin fecha
								</MudChip>
							}
						</MudTd>
						<MudTd>
							<MudMenu Icon="@Icons.Material.Filled.MoreVert"
									 Size="Size.Small"
									 Dense="true"
									 Class="action-menu">
								<MudMenuItem Icon="@Icons.Material.Filled.Visibility"
											 OnClick="@(() => VerDetalles(row))"
											 Class="menu-item-view">
									Ver Detalles
								</MudMenuItem>
								<MudMenuItem Icon="@Icons.Material.Filled.Edit"
											 OnClick="@(() => EditarPersona(row))"
											 Class="menu-item-edit">
									Editar
								</MudMenuItem>
								@if (row.Activo == true)
								{
									<MudMenuItem Icon="@Icons.Material.Filled.PersonOff"
												 OnClick="@(() => DesactivarPersona(row))"
												 Class="menu-item-deactivate">
										Desactivar
									</MudMenuItem>
								}
								else
								{
									<MudMenuItem Icon="@Icons.Material.Filled.PersonAdd"
												 OnClick="@(() => ActivarPersona(row))"
												 Class="menu-item-activate">
										Activar
									</MudMenuItem>
								}
								<MudDivider Class="my-1" />
								<MudMenuItem Icon="@Icons.Material.Filled.Delete"
											 OnClick="@(() => EliminarPersona(row))"
											 Class="menu-item-delete">
									Eliminar
								</MudMenuItem>
							</MudMenu>
						</MudTd>
					</RowTemplate>
					<NoRecordsContent>
						<MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info" Class="ma-4">
							<MudText>No se encontraron personas con los filtros aplicados.</MudText>
						</MudAlert>
					</NoRecordsContent>
					<PagerContent>
						<MudTablePager RowsPerPageString="Personas por página:"
									   InfoFormat="@("{first_item}-{last_item} de {all_items}")"
									   PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
					</PagerContent>
				</MudTable>
			</MudItem>
		</MudGrid>
	</MudPaper>
</MudContainer>

<style>
	/* Button Styles */
	.new-person-button .mud-button {
		background-color: #03346c !important;
		color: white !important;
		transition: all 0.3s ease;
	}

		.new-person-button .mud-button:hover {
			background-color: #024590 !important;
			transform: translateY(-1px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.2);
		}

	.toggle-view-button .mud-button {
		background-color: #6c757d !important;
		color: white !important;
		transition: all 0.3s ease;
	}

		.toggle-view-button .mud-button:hover {
			background-color: #5a6268 !important;
			transform: translateY(-1px);
		}

	.search-button {
		min-width: 120px;
	}

	/* Table Styles */
	.custom-table {
		border-radius: 8px;
		overflow: hidden;
	}

		.custom-table .mud-table-head {
			background-color: #f8f9fa;
		}

		.custom-table .mud-table-row:hover {
			background-color: #f0f7ff;
			transition: background-color 0.2s ease;
		}

	/* Text and Layout */
	.text-truncate {
		white-space: nowrap;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	.email-cell {
		max-width: 200px;
	}

	.id-chip {
		font-weight: 600;
	}

	/* Loading Animation */
	.loading-container {
		height: 50vh;
		padding: 2rem;
	}

	.pulse-img {
		animation: pulse 2s infinite;
	}

	@@keyframes pulse {
		0% {
			opacity: 1;
			transform: scale(1);
		}

		50% {
			opacity: 0.7;
			transform: scale(1.05);
		}

		100% {
			opacity: 1;
			transform: scale(1);
		}
	}

	/* Mobile Cards */
	.mobile-card {
		border-left: 4px solid #03346c;
		transition: transform 0.2s ease, box-shadow 0.2s ease;
	}

		.mobile-card:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 16px rgba(0,0,0,0.15);
		}

	.text-primary {
		color: #03346c !important;
	}

	/* Menu Items */
	.menu-item-view:hover {
		background-color: rgba(33, 150, 243, 0.1);
	}

	.menu-item-edit:hover {
		background-color: rgba(255, 152, 0, 0.1);
	}

	.menu-item-activate:hover {
		background-color: rgba(76, 175, 80, 0.1);
	}

	.menu-item-deactivate:hover {
		background-color: rgba(255, 193, 7, 0.1);
	}

	.menu-item-delete:hover {
		background-color: rgba(244, 67, 54, 0.1);
		color: #f44336 !important;
	}
</style>

@code {
	// Variables principales
	private bool loading = true;
	private string searchString = "";
	private int? filtroRol = null;
	private int? filtroSucursal = null;
	private int? filtroGenero = null;
	private int? filtroEstadoCivil = null;
	private bool mostrarInactivos = false;

	// Datos de referencia
	private List<Rol> roles = new();
	private List<Sucursal> sucursales = new();
	private List<Genero> generos = new();
	private List<EstadoCivil> estadosCiviles = new();

	// Referencias de componentes
	private MudTable<Persona>? table;
	private TableData<Persona> currentTableData = new() { Items = new List<Persona>(), TotalItems = 0 };

	// Control de ciclo de vida y concurrencia
	private bool _disposed = false;
	private readonly SemaphoreSlim _loadingSemaphore = new(1, 1);
	private CancellationTokenSource? _cancellationTokenSource;

	protected override async Task OnInitializedAsync()
	{
		_cancellationTokenSource = new CancellationTokenSource();

		try
		{
			await CargarDatosIniciales();
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error en OnInitializedAsync: {ex}");
			if (!_disposed)
			{
				Snackbar.Add($"Error al cargar datos iniciales: {ex.Message}", Severity.Error);
			}
		}
		finally
		{
			if (!_disposed)
			{
				loading = false;
				StateHasChanged();
			}
		}
	}

	// Métodos auxiliares para obtener texto de forma segura
	private string GetRolText(Persona persona)
	{
		try
		{
			return persona?.IdRoolNavigation?.TipoRol ?? "";
		}
		catch
		{
			return "";
		}
	}

	private string GetSucursalText(Persona persona)
	{
		try
		{
			if (persona?.IdSucursal.HasValue == true && sucursales?.Any() == true)
			{
				var sucursal = sucursales.FirstOrDefault(s => s.IdSucursal == persona.IdSucursal);
				return sucursal?.NombreSucursal ?? "";
			}
			return "";
		}
		catch
		{
			return "";
		}
	}

	private string GetTelefonoText(Persona persona)
	{
		try
		{
			return persona?.IdTelefonoNavigation?.NumeroTelefonico?.ToString() ?? "";
		}
		catch
		{
			return "";
		}
	}

	// Eventos de búsqueda con control de concurrencia
	private async Task OnSearchChanged()
	{
		if (_disposed || _cancellationTokenSource?.Token.IsCancellationRequested == true) return;

		await _loadingSemaphore.WaitAsync();
		try
		{
			if (!_disposed && table != null)
			{
				await table.ReloadServerData();
			}
		}
		finally
		{
			_loadingSemaphore.Release();
		}
	}

	private async Task OnSearchKeyUp(KeyboardEventArgs e)
	{
		if (e.Key == "Enter" && !_disposed && table != null)
		{
			await OnSearchChanged();
		}
	}

	private async Task OnBuscarClick()
	{
		await OnSearchChanged();
	}

	private async Task CambiarVistaPersonas()
	{
		if (_disposed) return;

		mostrarInactivos = !mostrarInactivos;
		await OnSearchChanged();
	}

	private async Task LimpiarFiltros()
	{
		if (_disposed) return;

		searchString = "";
		filtroRol = null;
		filtroSucursal = null;
		filtroGenero = null;
		filtroEstadoCivil = null;

		await OnSearchChanged();
	}

	// Navegación
	private void VerDetalles(Persona persona)
	{
		if (!_disposed)
		{
			NavigationManager.NavigateTo($"/personas/detalles/{persona.IdPersona}");
		}
	}

	private void EditarPersona(Persona persona)
	{
		if (!_disposed)
		{
			NavigationManager.NavigateTo($"/personas/editar/{persona.IdPersona}");
		}
	}

	// Operaciones CRUD
	private async Task DesactivarPersona(Persona persona)
	{
		if (_disposed) return;

		bool? result = await DialogService.ShowMessageBox(
			"Confirmar desactivación",
			$"¿Está seguro que desea desactivar a {persona.Nombre} {persona.Apellido}?",
			yesText: "Desactivar",
			noText: "Cancelar",
			options: new DialogOptions() { MaxWidth = MaxWidth.Small });

		if (result == true && !_disposed)
		{
			try
			{
				persona.Activo = false;
				bool actualizado = await PersonaService.UpdateAsync(persona);

				if (actualizado && !_disposed)
				{
					await MostrarExito($"Persona {persona.Nombre} {persona.Apellido} desactivada exitosamente");
					if (table != null)
					{
						await table.ReloadServerData();
					}
				}
				else if (!_disposed)
				{
					await MostrarError("No se pudo desactivar la persona");
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error en DesactivarPersona: {ex}");
				if (!_disposed)
				{
					await MostrarError($"Error al desactivar la persona: {ex.Message}");
				}
			}
		}
	}

	private async Task ActivarPersona(Persona persona)
	{
		if (_disposed) return;

		try
		{
			persona.Activo = true;
			bool actualizado = await PersonaService.UpdateAsync(persona);

			if (actualizado && !_disposed)
			{
				await MostrarExito($"Persona {persona.Nombre} {persona.Apellido} activada exitosamente");
				if (table != null)
				{
					await table.ReloadServerData();
				}
			}
			else if (!_disposed)
			{
				await MostrarError("No se pudo activar la persona");
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error en ActivarPersona: {ex}");
			if (!_disposed)
			{
				await MostrarError($"Error al activar la persona: {ex.Message}");
			}
		}
	}

	private async Task EliminarPersona(Persona persona)
	{
		if (_disposed) return;

		bool? result = await DialogService.ShowMessageBox(
			"⚠️ Confirmar eliminación",
			$"¿Está seguro que desea eliminar permanentemente a {persona.Nombre} {persona.Apellido}?\n\nEsta acción NO se puede deshacer y eliminará todos los datos relacionados con esta persona.",
			yesText: "Eliminar",
			noText: "Cancelar",
			options: new DialogOptions() { MaxWidth = MaxWidth.Small });

		if (result == true && !_disposed)
		{
			try
			{
				bool eliminado = await PersonaService.DeleteAsync(persona.IdPersona);

				if (eliminado && !_disposed)
				{
					await MostrarExito($"Persona {persona.Nombre} {persona.Apellido} eliminada exitosamente");
					if (table != null)
					{
						await table.ReloadServerData();
					}
				}
				else if (!_disposed)
				{
					await MostrarError("No se pudo eliminar la persona");
				}
			}
			catch (Exception ex)
			{
				Console.WriteLine($"Error en EliminarPersona: {ex}");
				if (!_disposed)
				{
					await MostrarError($"Error al eliminar la persona: {ex.Message}");
				}
			}
		}
	}

	// Carga de datos
	private async Task CargarDatosIniciales()
	{
		if (_disposed) return;

		try
		{
			loading = true;
			if (!_disposed) StateHasChanged();

			var tasks = new List<Task>
			{
				CargarRoles(),
				CargarSucursales(),
				CargarGeneros(),
				CargarEstadosCiviles()
			};

			await Task.WhenAll(tasks);
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error en CargarDatosIniciales: {ex}");
			if (!_disposed)
			{
				await MostrarError($"Error al cargar datos iniciales: {ex.Message}");
			}
		}
	}

	private async Task CargarRoles()
	{
		try
		{
			roles = await PersonaService.GetRolesAsync() ?? new List<Rol>();
			Console.WriteLine($"Roles cargados: {roles.Count}");
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error cargando roles: {ex.Message}");
			roles = new List<Rol>();
		}
	}

	private async Task CargarSucursales()
	{
		try
		{
			sucursales = await PersonaService.GetSucursalesAsync() ?? new List<Sucursal>();
			Console.WriteLine($"Sucursales cargadas: {sucursales.Count}");
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error cargando sucursales: {ex.Message}");
			sucursales = new List<Sucursal>();
		}
	}

	private async Task CargarGeneros()
	{
		try
		{
			generos = await PersonaService.GetGenerosAsync() ?? new List<Genero>();
			Console.WriteLine($"Géneros cargados: {generos.Count}");
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error cargando géneros: {ex.Message}");
			generos = new List<Genero>();
		}
	}

	private async Task CargarEstadosCiviles()
	{
		try
		{
			estadosCiviles = await PersonaService.GetEstadosCivilesAsync() ?? new List<EstadoCivil>();
			Console.WriteLine($"Estados civiles cargados: {estadosCiviles.Count}");
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error cargando estados civiles: {ex.Message}");
			estadosCiviles = new List<EstadoCivil>();
		}
	}

	// Método principal de carga de datos de la tabla con control de concurrencia
	private async Task<TableData<Persona>> LoadServerData(TableState state, CancellationToken cancellationToken)
	{
		if (_disposed || cancellationToken.IsCancellationRequested)
		{
			return new TableData<Persona> { Items = new List<Persona>(), TotalItems = 0 };
		}

		// Control de concurrencia mejorado
		if (!await _loadingSemaphore.WaitAsync(1000, cancellationToken))
		{
			Console.WriteLine("LoadServerData - Timeout esperando semáforo");
			return currentTableData;
		}

		try
		{
			loading = true;
			if (!_disposed) await InvokeAsync(StateHasChanged);

			// Logs para debugging
			Console.WriteLine($"LoadServerData - Page: {state.Page + 1}, PageSize: {state.PageSize}");
			Console.WriteLine($"Filtros - Search: '{searchString?.Trim()}', Rol: {filtroRol}, Sucursal: {filtroSucursal}, Mostrar Inactivos: {mostrarInactivos}");

			// Determinar orden
			bool ascending = state.SortDirection != SortDirection.Descending;
			string sortLabel = state.SortLabel ?? "Nombre";

			Console.WriteLine($"Orden: {sortLabel} {(ascending ? "ASC" : "DESC")}");

			// Validar parámetros
			var pageNumber = Math.Max(1, state.Page + 1);
			var pageSize = Math.Max(1, Math.Min(1000, state.PageSize));

			Console.WriteLine($"Llamando a PersonaService.GetPaginatedAsync...");

			// Crear CancellationToken combinado
			using var timeoutCts = new CancellationTokenSource(TimeSpan.FromSeconds(30));
			using var combinedCts = CancellationTokenSource.CreateLinkedTokenSource(
				cancellationToken,
				_cancellationTokenSource?.Token ?? CancellationToken.None,
				timeoutCts.Token);

			// Llamada al servicio con timeout
			var (personas, totalCount) = await PersonaService.GetPaginatedAsync(
				pageNumber,
				pageSize,
				searchString?.Trim(),
				ascending,
				sortLabel,
				mostrarInactivos,
				filtroRol,
				filtroSucursal,
				filtroGenero,
				filtroEstadoCivil
			);

			// Verificar si fue cancelado
			if (combinedCts.Token.IsCancellationRequested || _disposed)
			{
				Console.WriteLine("LoadServerData - Operación cancelada");
				return currentTableData;
			}

			Console.WriteLine($"PersonaService.GetPaginatedAsync completado - Personas: {personas?.Count ?? 0}, Total: {totalCount}");

			// Validar los datos recibidos
			if (personas == null)
			{
				Console.WriteLine("PersonaService devolvió null");
				personas = new List<Persona>();
			}

			if (personas.Any())
			{
				Console.WriteLine("Primeras 3 personas:");
				foreach (var p in personas.Take(3))
				{
					Console.WriteLine($"  - ID: {p?.IdPersona}, Nombre: {p?.Nombre} {p?.Apellido}, Email: {p?.Email}, Activo: {p?.Activo}");
				}
			}

			var tableData = new TableData<Persona>
			{
				Items = personas,
				TotalItems = Math.Max(0, totalCount)
			};

			// Guardar referencia para las cards móviles
			currentTableData = tableData;

			return tableData;
		}
		catch (OperationCanceledException)
		{
			Console.WriteLine("LoadServerData - Operación cancelada");
			return currentTableData;
		}
		catch (Exception ex)
		{
			Console.WriteLine($"ERROR en LoadServerData: {ex}");
			Console.WriteLine($"StackTrace: {ex.StackTrace}");

			if (!cancellationToken.IsCancellationRequested && !_disposed)
			{
				try
				{
					await InvokeAsync(async () => await MostrarError($"Error al cargar personas: {ex.Message}"));
				}
				catch (Exception innerEx)
				{
					Console.WriteLine($"Error al mostrar mensaje de error: {innerEx.Message}");
				}
			}

			return new TableData<Persona>
			{
				Items = new List<Persona>(),
				TotalItems = 0
			};
		}
		finally
		{
			_loadingSemaphore.Release();

			if (!_disposed)
			{
				loading = false;
				try
				{
					await InvokeAsync(StateHasChanged);
				}
				catch (Exception ex)
				{
					Console.WriteLine($"Error en StateHasChanged final: {ex.Message}");
				}
			}
		}
	}

	// Métodos auxiliares para mensajes
	private async Task MostrarExito(string mensaje)
	{
		try
		{
			if (!_disposed)
			{
				await InvokeAsync(() => Snackbar.Add(mensaje, Severity.Success));
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error en MostrarExito: {ex.Message}");
		}
	}

	private async Task MostrarError(string mensaje)
	{
		try
		{
			if (!_disposed)
			{
				await InvokeAsync(() => Snackbar.Add(mensaje, Severity.Error));
			}
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error en MostrarError: {ex.Message}");
		}
	}

	// Implementar IDisposable
	public void Dispose()
	{
		if (!_disposed)
		{
			_disposed = true;
			_cancellationTokenSource?.Cancel();
			_cancellationTokenSource?.Dispose();
			_loadingSemaphore?.Dispose();
		}
	}
}